<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>현대·기아 영업 장부 PRO</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --hyundai: #002c5f; --kia: #ea0029; --accent: #0076c0; --success: #28a745; --danger: #dc3545; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; padding: 10px; background: #f2f4f7; color: #333; margin: 0; padding-bottom: 30px; }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2 { color: var(--hyundai); font-size: 1.1em; margin-top: 0; border-left: 4px solid var(--hyundai); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
       
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .stat-box { background: var(--hyundai); color: white; padding: 12px; border-radius: 10px; text-align: center; }
        .stat-label { font-size: 0.7em; opacity: 0.8; }
        .stat-value { font-size: 1.1em; font-weight: 800; margin-top: 3px; }

        .brand-tab { display: flex; gap: 8px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        .tab-btn.active.hyundai { background: var(--hyundai); color: white; border-color: var(--hyundai); }
        .tab-btn.active.kia { background: var(--kia); color: white; border-color: var(--kia); }

        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.8em; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
       
        .btn-save { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }

        .history-list { max-height: 400px; overflow-y: auto; }
        .history-item { padding: 12px 0; border-bottom: 1px solid #eee; font-size: 0.85em; }
        .item-main { display: flex; justify-content: space-between; align-items: flex-start; }
        .customer-name { font-size: 1.05em; color: var(--hyundai); font-weight: 800; margin-bottom: 2px; }
        .item-details { font-size: 0.8em; color: #777; margin-top: 4px; display: flex; flex-wrap: wrap; gap: 8px; }
        .brand-badge { font-size: 0.7em; padding: 1px 4px; border-radius: 3px; color: white; margin-right: 4px; vertical-align: middle; }
        .bg-h { background: var(--hyundai); }
        .bg-k { background: var(--kia); }
        .val-plus { color: var(--success); font-weight: bold; }
        .val-minus { color: var(--danger); font-weight: bold; }
        .btn-delete { color: #ccc; border: none; background: none; cursor: pointer; font-size: 1.1em; padding: 0 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>실적 리포트 <select id="viewMonth" class="month-selector" onchange="render()"></select></h2>
        <div id="chart_div" style="width:100%; height:140px; background:#f9f9f9; border-radius:10px;"></div>
        <div class="dashboard">
            <div class="stat-box"><div class="stat-label">판매 대수</div><div class="stat-value"><span id="totalCount">0</span> 대</div></div>
            <div class="stat-box" style="background: var(--success);"><div class="stat-label">이달의 합계 수익</div><div class="stat-value"><span id="totalIncome">0</span> 원</div></div>
        </div>
    </div>

    <div class="card">
        <h2>판매 및 지출 등록</h2>
        <div class="brand-tab">
            <button id="btnH" class="tab-btn active hyundai" onclick="setBrand('H')">현대</button>
            <button id="btnK" class="tab-btn" onclick="setBrand('K')">기아</button>
        </div>

        <label>고객명</label>
        <input type="text" id="customerName" placeholder="예: 홍길동 (그랜저)" style="border-color: var(--accent);">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label>차종</label>
                <select id="carModel" onchange="autoCalculate()"></select>
            </div>
            <div>
                <label>차량 가격 (원)</label>
                <input type="number" id="carPrice" placeholder="정가 입력" oninput="autoCalculate()">
            </div>
        </div>

        <div id="kiaOption" style="display:none;">
            <label>기아 수당 비율</label>
            <select id="kiaRatio" onchange="autoCalculate()">
                <option value="0.8">80% 적용</option>
                <option value="0.9">90% 적용</option>
            </select>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
            <div><label>계산수당</label><input type="number" id="calcIncome"></div>
            <div><label>기타수입(+)</label><input type="number" id="extraIncome" value="0"></div>
            <div><label>영업비(-)</label><input type="number" id="expense" value="0"></div>
        </div>

        <button id="saveBtn" class="btn-save" onclick="saveRecord()">장부 기록하기</button>
    </div>

    <div class="card">
        <h2>판매 상세 내역</h2>
        <div id="historyList" class="history-list"></div>
    </div>
</div>

<script>
    let currentBrand = 'H';
    const hyundaiModels = [{n:'아반떼', r:0.07}, {n:'쏘나타', r:0.06}, {n:'베뉴', r:0.068}, {n:'코나', r:0.058}, {n:'투싼', r:0.055}, {n:'싼타페', r:0.053}, {n:'그랜저', r:0.05}, {n:'팰리세이드', r:0.048}, {n:'팰리세이드 HEV', r:0.046}, {n:'G70', r:0.047}, {n:'GV70/G80', r:0.043}, {n:'GV80', r:0.041}, {n:'G90', r:0.035}, {n:'G90 리무진', r:0.032}];
    const kiaModels = [{n:'모닝', r:0.075}, {n:'레이', r:0.075}, {n:'K3', r:0.07}, {n:'K5', r:0.06}, {n:'K8', r:0.05}, {n:'K9', r:0.043}, {n:'셀토스', r:0.055}, {n:'스포티지', r:0.055}, {n:'쏘렌토', r:0.055}, {n:'니로HEV', r:0.06}, {n:'카니발', r:0.06}];

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(() => {
        initMonthSelector();
        setBrand('H');
        render();
    });

    function setBrand(b) {
        currentBrand = b;
        document.getElementById('btnH').className = 'tab-btn' + (b==='H'?' active hyundai':'');
        document.getElementById('btnK').className = 'tab-btn' + (b==='K'?' active kia':'');
        document.getElementById('kiaOption').style.display = (b==='K') ? 'block' : 'none';
        document.getElementById('saveBtn').style.background = (b==='K') ? 'var(--kia)' : 'var(--accent)';
        updateModelList();
    }

    function updateModelList() {
        const sel = document.getElementById('carModel');
        sel.innerHTML = "";
        const list = (currentBrand === 'H') ? hyundaiModels : kiaModels;
        list.forEach(m => sel.add(new Option(m.n, m.r)));
        autoCalculate();
    }

    function autoCalculate() {
        const price = parseFloat(document.getElementById('carPrice').value) || 0;
        const rate = parseFloat(document.getElementById('carModel').value);
        let val = 0;
        if(currentBrand === 'H') val = (price / 1.15863) * rate * 0.7 * 0.967;
        else val = (price / 1.15863) * rate * parseFloat(document.getElementById('kiaRatio').value) * 0.967;
        document.getElementById('calcIncome').value = Math.floor(val);
    }

    function saveRecord() {
        const customer = document.getElementById('customerName').value.trim() || "미지정 고객";
        const calcVal = parseInt(document.getElementById('calcIncome').value) || 0;
        const extraVal = parseInt(document.getElementById('extraIncome').value) || 0;
        const expVal = parseInt(document.getElementById('expense').value) || 0;
        const finalNet = calcVal + extraVal - expVal;

        const now = new Date();
        const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const carName = document.getElementById('carModel').options[document.getElementById('carModel').selectedIndex].text;
       
        const record = {
            id: Date.now(),
            customer: customer,
            brand: currentBrand,
            carName: carName,
            calcIncome: calcVal,
            extraIncome: extraVal,
            expense: expVal,
            finalNet: finalNet,
            date: now.toLocaleDateString()
        };
       
        let data = JSON.parse(localStorage.getItem(monthKey) || "[]");
        data.push(record);
        localStorage.setItem(monthKey, JSON.stringify(data));
       
        document.getElementById('customerName').value = "";
        document.getElementById('carPrice').value = "";
        document.getElementById('extraIncome').value = 0;
        document.getElementById('expense').value = 0;
       
        alert(`${customer}님 판매 내역이 저장되었습니다.`);
        render();
    }

    function render() {
        const selectedMonth = document.getElementById('viewMonth').value;
        if(!selectedMonth) return;

        const monthData = JSON.parse(localStorage.getItem(selectedMonth) || "[]");
        let totalNet = 0;
        const listEl = document.getElementById('historyList');
        listEl.innerHTML = monthData.length ? "" : '<div style="text-align:center;color:#999;padding:20px;">기록이 없습니다.</div>';
       
        monthData.slice().reverse().forEach(item => {
            totalNet += parseInt(item.finalNet || 0);
            const bBadge = item.brand === 'H' ? '<span class="brand-badge bg-h">현대</span>' : '<span class="brand-badge bg-k">기아</span>';
            listEl.innerHTML += `
                <div class="history-item">
                    <div class="item-main">
                        <div>
                            <div class="customer-name">${item.customer}</div>
                            ${bBadge}<strong>${item.carName}</strong>
                        </div>
                        <div style="text-align:right">
                            <strong>${parseInt(item.finalNet).toLocaleString()}원</strong><br>
                            <button class="btn-delete" onclick="deleteItem('${selectedMonth}', ${item.id})">✕ 삭제</button>
                        </div>
                    </div>
                    <div class="item-details">
                        <span>수당: ${parseInt(item.calcIncome).toLocaleString()}</span>
                        <span class="val-plus">기타: +${parseInt(item.extraIncome).toLocaleString()}</span>
                        <span class="val-minus">영업비: -${parseInt(item.expense).toLocaleString()}</span>
                        <span style="margin-left:auto">${item.date}</span>
                    </div>
                </div>`;
        });

        document.getElementById('totalCount').innerText = monthData.length;
        document.getElementById('totalIncome').innerText = totalNet.toLocaleString();
        if (google.visualization && google.visualization.LineChart) drawChart();
    }

    function deleteItem(m, id) {
        if(confirm("이 기록을 삭제하시겠습니까?")) {
            let d = JSON.parse(localStorage.getItem(m)).filter(i => i.id !== id);
            localStorage.setItem(m, JSON.stringify(d));
            render();
        }
    }

    function drawChart() {
        const months = []; const now = new Date();
        for(let i=5; i>=0; i--) {
            let d = new Date(now.getFullYear(), now.getMonth()-i, 1);
            months.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}`);
        }
        const chartData = [['Month', '순수익']];
        months.forEach(m => {
            const data = JSON.parse(localStorage.getItem(m) || "[]");
            chartData.push([m.split('-')[1]+'월', data.reduce((acc, cur) => acc + parseInt(cur.finalNet || 0), 0)]);
        });
        new google.visualization.LineChart(document.getElementById('chart_div')).draw(google.visualization.arrayToDataTable(chartData), { curveType: 'function', legend: 'none', colors: ['#0076c0'], chartArea: {width:'85%', height:'70%'} });
    }

    function initMonthSelector() {
        const sel = document.getElementById('viewMonth');
        const now = new Date();
        for (let i = 0; i < 12; i++) {
            let d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            let k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            sel.add(new Option(`${d.getFullYear()}년 ${d.getMonth() + 1}월`, k));
        }
    }
</script>
</body>
</html>
