<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>현대·기아 영업 매니저 PRO</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --hyundai: #002c5f; --kia: #ea0029; --accent: #0076c0; --success: #28a745; --danger: #dc3545; --gray: #666; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; padding: 0; background: #f2f4f7; color: #333; margin: 0; }
        .container { max-width: 500px; margin: auto; padding: 15px; }
       
        .nav-tab { display: flex; background: white; border-radius: 15px; margin-bottom: 10px; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .nav-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: bold; border-radius: 10px; cursor: pointer; color: #999; font-size: 0.85em; }
        .nav-btn.active { background: var(--hyundai); color: white; }

        /* 백업 버튼 전용 */
        .backup-bar { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-backup { flex: 1; padding: 8px; background: #555; color: white; border: none; border-radius: 8px; font-size: 0.75em; font-weight: bold; }

        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2 { color: var(--hyundai); font-size: 1.1em; margin-top: 0; border-left: 4px solid var(--hyundai); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
       
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.8em; color: var(--gray); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; }
        .btn-main { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
       
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .stat-box { background: var(--hyundai); color: white; padding: 12px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 1.1em; font-weight: 800; }

        .item { padding: 12px 0; border-bottom: 1px solid #eee; cursor: pointer; }
        .badge { font-size: 0.7em; padding: 2px 5px; border-radius: 4px; color: white; margin-right: 5px; }
        .st-진행중 { background: #ff9800; } .st-계약 { background: #6f42c1; } .st-완료 { background: var(--success); } .st-실패 { background: var(--danger); }
       
        .detail-view { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 0.85em; display: none; border: 1px solid #eee; }
        .detail-view.active { display: block; }
        .detail-label { color: var(--accent); font-weight: bold; margin-right: 5px; }

        .history-list { max-height: 450px; overflow-y: auto; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="backup-bar">
        <button class="btn-backup" onclick="exportData()">엑셀(CSV) 저장</button>
        <button class="btn-backup" onclick="copyToClipboard()">전체데이터 복사(카톡 보관용)</button>
        <button class="btn-backup" style="background:var(--danger)" onclick="importData()">데이터 복원</button>
    </div>

    <div class="nav-tab">
        <button id="navConsult" class="nav-btn active" onclick="showTab('consult')">1.상담</button>
        <button id="navContract" class="nav-btn" onclick="showTab('contract')">2.계약</button>
        <button id="navSales" class="nav-btn" onclick="showTab('sales')">3.판매실적</button>
    </div>

    <div id="tabConsult">
        <div class="card">
            <h2>상담 등록</h2>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <button id="cBtnH" class="nav-btn active" style="border:1px solid #ddd" onclick="setBrand('H')">현대</button>
                <button id="cBtnK" class="nav-btn" style="border:1px solid #ddd" onclick="setBrand('K')">기아</button>
            </div>
            <input type="text" id="cName" placeholder="고객명">
            <input type="date" id="cDate">
            <input type="text" id="cModel" placeholder="차종 (예: 그랜저)">
            <textarea id="cNote" placeholder="특이사항" rows="2"></textarea>
            <textarea id="cService" placeholder="서비스 내용" rows="2"></textarea>
            <button class="btn-main" onclick="saveConsult()">상담 내역 저장</button>
        </div>
        <div class="card">
            <h2>상담 현황</h2>
            <div id="consultList" class="history-list"></div>
        </div>
    </div>

    <div id="tabContract" class="hidden">
        <div class="card">
            <h2>계약 고객 리스트</h2>
            <div id="contractList" class="history-list"></div>
        </div>
    </div>

    <div id="tabSales" class="hidden">
        <div class="card">
            <h2>판매실적 리포트 <select id="viewMonth" onchange="renderSales()"></select></h2>
            <div id="chart_div" style="width:100%; height:120px;"></div>
            <div class="dashboard">
                <div class="stat-box"><div>판매량</div><div class="stat-value"><span id="totalCount">0</span>대</div></div>
                <div class="stat-box" style="background: var(--success);"><div>총 수익</div><div class="stat-value"><span id="totalIncome">0</span>원</div></div>
            </div>
        </div>
       
        <div id="salesFinalInput" class="card hidden" style="border: 2px solid var(--success);">
            <h2 style="color:var(--success)">판매완료 확정</h2>
            <p id="sTargetName" style="font-weight:bold; margin-bottom:10px;"></p>
            <input type="number" id="sPrice" placeholder="차량 가격 (수당 계산용)" oninput="autoCalcSales()">
            <div id="sKiaRatioArea" class="hidden">
                <label>기아 수당 비율</label>
                <select id="sKiaRatio" onchange="autoCalcSales()"><option value="0.8">80%</option><option value="0.9">90%</option></select>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <div><label>수당</label><input type="number" id="sCalc"></div>
                <div><label>기타(+)</label><input type="number" id="sExtra" value="0"></div>
                <div><label>영업비(-)</label><input type="number" id="sExp" value="0"></div>
            </div>
            <button class="btn-main" style="background:var(--success)" onclick="completeFinalSale()">최종 실적 저장</button>
            <button class="btn-main" style="background:#ccc; margin-top:5px;" onclick="cancelFinalSale()">취소</button>
        </div>

        <div class="card">
            <h2>판매고객 리스트</h2>
            <div id="salesList" class="history-list"></div>
        </div>
    </div>
</div>

<script>
    /* [기존 로직 유지 영역] */
    let currentBrand = 'H'; let tempContract = null;
    const hyundaiModels = [{n:'아반떼', r:0.07}, {n:'쏘나타', r:0.06}, {n:'베뉴', r:0.068}, {n:'코나', r:0.058}, {n:'투싼', r:0.055}, {n:'싼타페', r:0.053}, {n:'그랜저', r:0.05}, {n:'팰리세이드', r:0.048}, {n:'팰리세이드 HEV', r:0.046}, {n:'G70', r:0.047}, {n:'GV70/G80', r:0.043}, {n:'GV80', r:0.041}, {n:'G90', r:0.035}, {n:'G90 리무진', r:0.032}];
    const kiaModels = [{n:'모닝', r:0.075}, {n:'레이', r:0.075}, {n:'K3', r:0.07}, {n:'K5', r:0.06}, {n:'K8', r:0.05}, {n:'K9', r:0.043}, {n:'셀토스', r:0.055}, {n:'스포티지', r:0.055}, {n:'쏘렌토', r:0.055}, {n:'니로HEV', r:0.06}, {n:'카니발', r:0.06}];
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(() => { init(); });
    function init() { document.getElementById('cDate').valueAsDate = new Date(); initMonthSelector(); renderConsult(); renderContract(); renderSales(); }
    function showTab(type) { ['Consult', 'Contract', 'Sales'].forEach(t => { document.getElementById('tab'+t).classList.toggle('hidden', type.toLowerCase() !== t.toLowerCase()); document.getElementById('nav'+t).classList.toggle('active', type.toLowerCase() === t.toLowerCase()); }); if(type === 'sales') renderSales(); }
    function setBrand(b) { currentBrand = b; document.getElementById('cBtnH').classList.toggle('active', b==='H'); document.getElementById('cBtnK').classList.toggle('active', b==='K'); }

    // --- 백업 및 복원 핵심 기능 ---

    // 1. 전체 데이터를 텍스트로 복사 (카톡 나에게 보내기 용)
    function copyToClipboard() {
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            allData[key] = localStorage.getItem(key);
        }
        const textData = JSON.stringify(allData);
       
        const textArea = document.createElement("textarea");
        textArea.value = textData;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert("전체 데이터가 복사되었습니다! \n카카오톡 '나와의 채팅방'에 붙여넣어 보관하세요. \n나중에 이 텍스트를 이용해 복원할 수 있습니다.");
        } catch (err) {
            alert("복사 실패. 브라우저 설정을 확인하세요.");
        }
        document.body.removeChild(textArea);
    }

    // 2. 텍스트 데이터를 입력하여 복원
    function importData() {
        const jsonText = prompt("복사해두었던 데이터 텍스트를 붙여넣으세요.");
        if (jsonText) {
            try {
                const data = JSON.parse(jsonText);
                if(confirm("기존 데이터가 모두 삭제되고 복원됩니다. 계속할까요?")) {
                    localStorage.clear();
                    for (const key in data) {
                        localStorage.setItem(key, data[key]);
                    }
                    alert("데이터 복원이 완료되었습니다!");
                    location.reload();
                }
            } catch (e) {
                alert("유효한 데이터 형식이 아닙니다.");
            }
        }
    }

    // 3. 엑셀(CSV) 파일로 내보내기 (PC 및 아이폰 파일앱 저장용)
    function exportData() {
        const month = document.getElementById('viewMonth').value;
        const data = JSON.parse(localStorage.getItem(month) || "[]");
        if(data.length === 0) return alert("내보낼 데이터가 없습니다.");

        let csv = "\ufeff고객명,차종,최종수익,수당,기타수입,영업비,날짜,특이사항\n";
        data.forEach(item => {
            csv += `${item.name},${item.model},${item.finalNet},${item.calcIncome},${item.extraIncome},${item.expense},${item.saleDate},"${item.note.replace(/"/g, '""')}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `영업장부_${month}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    /* [이하 기존 렌더링 및 저장 로직 동일] */
    function saveConsult() { const name = document.getElementById('cName').value.trim(); if(!name) return alert("고객명 입력!"); const data = { id: Date.now(), brand: currentBrand, name, date: document.getElementById('cDate').value, model: document.getElementById('cModel').value, note: document.getElementById('cNote').value, service: document.getElementById('cService').value, status: '진행중' }; let list = JSON.parse(localStorage.getItem('consultData') || "[]"); list.push(data); localStorage.setItem('consultData', JSON.stringify(list)); alert("상담 저장 완료"); clearConsultForm(); renderConsult(); }
    function renderConsult() { const list = JSON.parse(localStorage.getItem('consultData') || "[]"); const listEl = document.getElementById('consultList'); listEl.innerHTML = list.length ? "" : "<div style='text-align:center;padding:20px;color:#999'>내역 없음</div>"; list.slice().reverse().forEach(item => { listEl.innerHTML += `<div class="item" onclick="toggleDetail('c-${item.id}')"><div style="display:flex; justify-content:space-between"><strong>${item.name} (${item.model})</strong><span class="badge st-진행중">상담중</span></div><div id="detail-c-${item.id}" class="detail-view"><p><span class="detail-label">메모:</span> ${item.note}</p><button class="btn-main" style="padding:8px; font-size:0.8em; margin-top:5px;" onclick="moveToContract(${item.id})">계약 전환</button><button onclick="deleteData('consultData', ${item.id}, renderConsult)" style="color:var(--danger); border:none; background:none; font-size:0.8em; float:right;">삭제</button></div></div>`; }); }
    function moveToContract(id) { event.stopPropagation(); let cList = JSON.parse(localStorage.getItem('consultData') || "[]"); const item = cList.find(i => i.id === id); if(confirm(`[${item.name}] 계약 이동?`)) { let kList = JSON.parse(localStorage.getItem('contractData') || "[]"); item.status = '계약중'; kList.push(item); localStorage.setItem('contractData', JSON.stringify(kList)); localStorage.setItem('consultData', JSON.stringify(cList.filter(i => i.id !== id))); renderConsult(); renderContract(); showTab('contract'); } }
    function renderContract() { const list = JSON.parse(localStorage.getItem('contractData') || "[]"); const listEl = document.getElementById('contractList'); listEl.innerHTML = list.length ? "" : "<div style='text-align:center;padding:20px;color:#999'>계약 없음</div>"; list.slice().reverse().forEach(item => { listEl.innerHTML += `<div class="item" onclick="toggleDetail('k-${item.id}')"><div style="display:flex; justify-content:space-between"><strong>${item.name} (${item.model})</strong><span class="badge st-계약">계약중</span></div><div id="detail-k-${item.id}" class="detail-view"><p>${item.note}</p><button class="btn-main" style="padding:8px; font-size:0.8em; background:var(--success)" onclick="openFinalInput(${item.id})">판매완료(실적연동)</button><button onclick="deleteData('contractData', ${item.id}, renderContract)" style="color:var(--danger); border:none; background:none; font-size:0.8em; float:right;">삭제</button></div></div>`; }); }
    function openFinalInput(id) { event.stopPropagation(); const list = JSON.parse(localStorage.getItem('contractData') || "[]"); tempContract = list.find(i => i.id === id); showTab('sales'); document.getElementById('salesFinalInput').classList.remove('hidden'); document.getElementById('sTargetName').innerText = `고객: ${tempContract.name}`; document.getElementById('sKiaRatioArea').style.display = (tempContract.brand==='K') ? 'block' : 'none'; autoCalcSales(); }
    function autoCalcSales() { if(!tempContract) return; const price = parseFloat(document.getElementById('sPrice').value) || 0; const models = tempContract.brand === 'H' ? hyundaiModels : kiaModels; const found = models.find(m => m.n === tempContract.model) || {r: 0.05}; let val = 0; if(tempContract.brand === 'H') val = (price / 1.15863) * found.r * 0.7 * 0.967; else val = (price / 1.15863) * found.r * parseFloat(document.getElementById('sKiaRatio').value) * 0.967; document.getElementById('sCalc').value = Math.floor(val); }
    function completeFinalSale() { const monthKey = document.getElementById('viewMonth').value; const calcVal = parseInt(document.getElementById('sCalc').value) || 0; const extraVal = parseInt(document.getElementById('sExtra').value) || 0; const expVal = parseInt(document.getElementById('sExp').value) || 0; const record = { ...tempContract, status: '판매완료', finalNet: calcVal + extraVal - expVal, calcIncome: calcVal, extraIncome: extraVal, expense: expVal, saleDate: new Date().toLocaleDateString() }; let sList = JSON.parse(localStorage.getItem(monthKey) || "[]"); sList.push(record); localStorage.setItem(monthKey, JSON.stringify(sList)); let kList = JSON.parse(localStorage.getItem('contractData') || "[]").filter(i => i.id !== tempContract.id); localStorage.setItem('contractData', JSON.stringify(kList)); alert("실적 등록 완료!"); cancelFinalSale(); renderContract(); renderSales(); }
    function cancelFinalSale() { tempContract = null; document.getElementById('salesFinalInput').classList.add('hidden'); document.getElementById('sPrice').value = ""; }
    function renderSales() { const month = document.getElementById('viewMonth').value; const data = JSON.parse(localStorage.getItem(month) || "[]"); let totalNet = 0; const listEl = document.getElementById('salesList'); listEl.innerHTML = data.length ? "" : "<div style='text-align:center;padding:20px;color:#999'>실적 없음</div>"; data.slice().reverse().forEach(item => { totalNet += item.finalNet; listEl.innerHTML += `<div class="item" onclick="toggleDetail('s-${item.id}')"><div style="display:flex; justify-content:space-between"><strong>${item.name} (${item.model})</strong><strong>${item.finalNet.toLocaleString()}원</strong></div><div id="detail-s-${item.id}" class="detail-view"><p>특이사항: ${item.note}</p><p>수당:${item.calcIncome.toLocaleString()} / 지출:${item.expense.toLocaleString()}</p><button onclick="deleteData('${month}', ${item.id}, renderSales)" style="color:var(--danger); border:none; background:none; font-size:0.8em;">삭제</button></div></div>`; }); document.getElementById('totalCount').innerText = data.length; document.getElementById('totalIncome').innerText = totalNet.toLocaleString(); drawChart(); }
    function toggleDetail(id) { const el = document.getElementById(`detail-${id}`); if(el) el.classList.toggle('active'); }
    function deleteData(key, id, callback) { event.stopPropagation(); if(confirm("삭제?")) { let list = JSON.parse(localStorage.getItem(key) || "[]").filter(i => i.id !== id); localStorage.setItem(key, JSON.stringify(list)); callback(); } }
    function clearConsultForm() { document.getElementById('cName').value = ""; document.getElementById('cModel').value = ""; document.getElementById('cNote').value = ""; document.getElementById('cService').value = ""; }
    function drawChart() { const months = []; const now = new Date(); for(let i=5; i>=0; i--) { let d = new Date(now.getFullYear(), now.getMonth()-i, 1); months.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}`); } const chartData = [['Month', '수입']]; months.forEach(m => { const d = JSON.parse(localStorage.getItem(m) || "[]"); chartData.push([m.split('-')[1]+'월', d.reduce((a, c) => a + c.finalNet, 0)]); }); new google.visualization.LineChart(document.getElementById('chart_div')).draw(google.visualization.arrayToDataTable(chartData), { curveType:'function', legend:'none', chartArea:{width:'85%',height:'70%'} }); }
    function initMonthSelector() { const sel = document.getElementById('viewMonth'); const now = new Date(); for (let i = 0; i < 12; i++) { let d = new Date(now.getFullYear(), now.getMonth() - i, 1); let k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; sel.add(new Option(`${d.getFullYear()}년 ${d.getMonth() + 1}월`, k)); } }
</script>
</body>
</html>
